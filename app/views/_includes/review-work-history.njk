{% set workHistory = data["work-history"] | toArray | sort(attribute="start-date") %}
{% if workHistory.length >= 1 %}
  <table class="govuk-table govuk-!-font-size-16">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th class="govuk-table__header" scope="col" width="30%">Job title</th>
        <th class="govuk-table__header" scope="col">Organisation</th>
        <th class="govuk-table__header" scope="col">Dates</th>
        <th class="govuk-table__header" scope="col">
          <span class="govuk-visually-hidden">Actions</span>
        </th>
      </tr>
    </thead>
    <tbody class="govuk-table__body">
    {# Candidate has no work history #}
    {% if data["work-history"]["missing"] %}
      <tr class="govuk-table__row app-table__row--muted">
        <td class="govuk-table__cell" colspan="3">
          <strong>No work history</strong>. {{ data["work-history"]["missing"] }}
        </td>
        <td class="govuk-table__cell">
          <a href="/profile/work-history/edit/missing?referrer={{ referrer }}">Edit<span class="govuk-visually-hidden"> missing</span></a>
        </td>
      </tr>
    {% endif %}

    {% for item in workHistory %}
      {% set nextItem = workHistory[loop.index] %}

      {# Unexplained gap (before work history commences) #}
      {% set periodStart = "now" | date | replace("2019", "2014") %}
      {% set periodStartEpoch = periodStart | date("X") %}

      {% set firstStart = item["start-date"] %}
      {% set firstStartEpoch = firstStart | date("X") %}

      {% if loop.first and firstStartEpoch > periodStartEpoch %}
        {# Gap starts at start of work history period #}
        {% set gapStartEpoch = periodStart | date("X") %}
        {% set gapStartDate = periodStart | date("LL/yyyy") %}
        {% set gapStartIso = periodStart | date("yyyy-LL") %}

        {# Gap ends with start date of current item in loop #}
        {% set gapEndEpoch = firstStart | date("X") %}
        {% set gapEndDate = firstStart | date("LL/yyyy") %}
        {% set gapEndIso = firstStart | date("yyyy-LL") %}

        {# Gap length #}
        {% set gapDuration = gapEndEpoch - gapStartEpoch %}
        {% set gapMonths = (gapDuration / 2678400) | round %}
        <tr class="govuk-table__row app-table__row--muted">
          <td class="govuk-table__cell">Unexplained gap ({{ gapMonths }} months)</td>
          <td class="govuk-table__cell"></td>
          <td class="govuk-table__cell">{{ gapStartDate }} - {{ gapEndDate }}</td>
          <td class="govuk-table__cell">
            <a href="/profile/work-history/add/gap?start={{ gapStartIso }}&end={{ gapEndIso }}">Explain&nbsp;gap</a>
          </td>
        </tr>
      {% endif %}

      {# Job/gap item #}
      {% set itemStartEpoch = item["start-date"] | date("X") %}
      {% set itemStartDate = item["start-date"] | date("LL/yyyy") %}
      {% if item["end-date"] != "-" %}
        {% set itemEndEpoch = item["end-date"] | date("X") %}
        {% set itemEndDate = item["end-date"] | date("LL/yyyy") %}
      {% else %}
        {% set itemEndEpoch = "now" | date("X") %}
        {% set itemEndDate = "Present" %}
      {% endif %}

      {# Item duration #}
      {% set itemDuration = itemEndEpoch - itemStartEpoch %}
      {% set itemMonths = (itemDuration / 2678400) | round %}

      <tr class="govuk-table__row">
        <th class="govuk-table__header">
        {% if item.category == "job" %}
          {{ item.role }}
        {% elif item.category == "gap" %}
          <span class="govuk-!-font-weight-regular">{{ itemMonths }} month gap</span>
        {% endif %}
        </th>
        <td class="govuk-table__cell">{{ item.org or item.description }}</td>
        <td class="govuk-table__cell">{{ itemStartDate }} - {{ itemEndDate }}</td>
        <td class="govuk-table__cell">
          <a href="/profile/work-history/edit/{{ item.category }}/{{ item.id }}?referrer={{ referrer }}">Edit<span class="govuk-visually-hidden"> {{ item.category }}</span></a>
        </td>
      </tr>

      {# Unexplained gaps (during work history) #}

      {# Gap starts with end date of current item in loop #}
      {% set gapStartEpoch = item["end-date"] | date("X") %}
      {% set gapStartDate = item["end-date"] | date("LL/yyyy") %}
      {% set gapStartIso = item["end-date"] | date("yyyy-LL") %}

      {# Gap ends with start date of next item in loop else today’s date #}
      {% if nextItem %}
        {% set gapEndEpoch = nextItem["start-date"] | date("X") %}
        {% set gapEndDate = nextItem["start-date"] | date("LL/yyyy") %}
        {% set gapEndIso = nextItem["start-date"] | date("yyyy-LL") %}
      {% else %}
        {% set gapEndEpoch = "now" | date("X") %}
        {% set gapEndDate = "Present" %}
        {% set gapEndIso = "now" | date("yyyy-LL") %}
      {% endif %}

      {# Gap duration #}
      {% set gapDuration = gapEndEpoch - gapStartEpoch %}
      {% set gapMonths = (gapDuration / 2678400) | round %}

      {% if gapEndEpoch > gapStartEpoch and gapMonths > 1 %}
        <tr class="govuk-table__row app-table__row--muted">
          <th class="govuk-table__cell">
            <span class="govuk-!-font-weight-regular">{{ gapMonths }} month gap</span>
          </th>
          <td class="govuk-table__cell">–</td>
          <td class="govuk-table__cell">{{ gapStartDate }} - {{ gapEndDate }}</td>
          <td class="govuk-table__cell">
            <a href="/profile/work-history/add/gap?start={{ gapStartIso }}&end={{ gapEndIso }}">Explain&nbsp;gap</a>
          </td>
        </tr>
      {% endif %}
    {% endfor %}
    </tbody>
  </table>
{% else %}
  <p class="govuk-body-s">No work history entered</p>
{% endif %}
