{% set complete = choices | length > 0 %}
{% if complete %}
  {% for item in choices %}
    {% set provider = providers[item.providerCode] %}
    {% set course = provider.courses[item.courseCode] %}
    {% set courseHtml %}
      {% include "_includes/item/choice.njk" %}
    {% endset %}

    {# Can respond if within a decision phase and have an offer #}
    {% set canRespond = canMakeDecision and
      item.status == "Offer received"
    %}

    {# Can withdraw if post-submission and not already withdrawn choice #}
    {% set canWithdraw = canWithdraw
      and (item.status != "Offer declined")
      and (item.status != "Offer received")
      and (item.status != "Unsuccessful")
      and (item.status != "Withdrawn")
      or (item.status == "Awaiting decision")
      or (item.status == "Offer accepted")
    %}

    {# Can request a deferral if has accepted an offer #}
    {% set canRequestDeferral = canRequestDeferral
      and (item.status == "Offer accepted")
    %}

    {# Candidate has already responded #}
    {% set hasResponded =
      (item.status == "Offer accepted")
      or (item.status == "Offer declined")
      or (item.status == "Unsuccessful")
      or (item.status == "Withdrawn")
    %}

    {{ appSummaryCard({
      classes: "govuk-!-margin-bottom-6",
      headingLevel: 3,
      titleText: provider.name,
      actions: {
        items: [{
          href: applicationPath + "/choices/" + item.id + "/delete?referrer=" + referrer,
          text: "Delete choice"
        } if canAmend, {
          href: applicationPath + "/" + item.id + "/request-deferral",
          text: "Ask if you can defer"
        } if canRequestDeferral, {
          href: applicationPath + "/" + item.id + "/withdraw",
          text: "Withdraw"
        } if canWithdraw, {
          href: applicationPath + "/" + item.id + "/view?phase=" + phase,
          text: "View and respond to offer"
        } if canRespond and not hasResponded]
      } if canAmend or canWithdraw or canRespond,
      html: courseHtml
    }) }}
  {% endfor %}
{% else %}
  {% if showIncomplete %}
    {% set incompleteType = "warning" if errorList %}
    {% set incompleteId = "choices" %}
    {% set incompleteText = "Course choices are not marked as completed" %}
    {% set incompleteLink = "/choices?referrer=" + referrer %}
    {% include "_includes/review/incomplete.njk" %}
  {% endif %}
{% endif %}
