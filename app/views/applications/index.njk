{% extends "_content.njk" %}

{% set title = "Application dashboard" %}
{% set hasSecondary = true %}
{% set referrer = "/applications&phase=" + phase %}
{% set applications = applications or data.applications %}
{% set applicationId = "" %}
{% set application = "" %}
{% if not phase %}
  {% set phase = "" %}
{% endif %}
{% for key, value in applications %}
  {% set applicationId = key %}
  {% set application = value %}
  {# If no phase provided, detirmine based on application status #}
  {# This is not fool proof! #}
  {% if not phase %}
    {% if application.status == "submitted" or application.status == "amending" %}
      {% set phase = "amend" %}
    {% elif application.status == "amended" %}
      {% set phase = "selection" %}
    {% else %}
      {% set phase = "submitted" %}
    {% endif %}
  {% endif %}
{% endfor %}

{% block beforePrimary %}

  {% set needsReferee = false %}
  {% if needsReferee %}
    {# <div class="app-banner">
      <h2 class="govuk-heading-m govuk-!-margin-bottom-0" id="success-message">
        You need to <a href="{{ applicationPath }}/references/alternative">give details of a new referee</a>
      </h2>
    </div> #}

    <div class="app-banner">
      <h2 class="govuk-heading-m govuk-!-margin-bottom-0" id="success-message">
        You need to <a href="{{ applicationPath }}/references/alternative-first">give details of 2 new referees</a>
      </h2>
    </div>
  {% endif %}

  <div class="app-banner">
    <h2 class="govuk-heading-m govuk-!-margin-bottom-0" id="success-message">
      <a href="/application/{{ applicationId }}/apply-again">Do you want to apply again?</a>
    </h2>
  </div>

  {# <div class="app-banner app-banner--success">
    <h2 class="govuk-heading-m govuk-!-margin-bottom-0" id="success-message">
      Thank you. We’ve asked your new referee for a reference
    </h2>
  </div> #}

  {# <div class="app-banner app-banner--success">
    <h2 class="govuk-heading-m govuk-!-margin-bottom-0" id="success-message">
      Thank you. We’ve asked each new referee for a reference
    </h2>
  </div> #}

  <h1 class="govuk-heading-xl govuk-!-margin-bottom-2">{{ title | safe }}</h1>
  <p class="govuk-hint govuk-!-margin-bottom-8">Application submitted on {{ "now" | date("d MMMM yyyy") }}. <a href="/application/{{ applicationId }}/submitted?phase={{ phase }}">View application</a></p>
{% endblock %}

{% block primary %}
  {% set applicationPath = "/application/" + applicationId %}
  {% set canAmend = phase == "amend" and application.status == "amending" %}
  {% set hasAmended = application.status == "amended" %}
  {% set canWithdraw = (application.status != "submitted") or (phase != "amend") %}
  {% set canMakeDecision = (phase == "decision") or (phase == "dbd") %}
  {% set showChoiceStatus = true %}
  {% set showReferenceStatus = true %}

  <h2 class="govuk-heading-m govuk-!-font-size-27">
  {% if canAmend %}
    Your application
  {% elif phase == "decision" %}
    Some of your training providers haven't reached a decision yet</h2>
  {% elif phase == "dbd" %}
    All your training providers have now reached a decision
  {% elif phase == "completed" %}
    You have accepted an offer
  {% else %}
    Courses you’ve applied to
  {% endif %}
  </h2>

  {# Guidance about amending an application #}
  {% if phase == "amend" and application.status == "submitted" %}
    <div class="govuk-inset-text">
      <p class="govuk-body">You have 7 days (until {{ 7 | nowPlusDays("d MMMM yyyy") }}) to edit your application or change your choice of provider, course or training location.</p>
      <p class="govuk-body"><a href="/application/{{ applicationId }}/edit">Edit your application</a></p>
    </div>
  {% elif phase == "amend" and application.status == "amending" %}
    {{ govukWarningText({
      html: "You have 5 days remaining (until " + (7 | nowPlusDays("d MMMM yyyy")) + ") to submit your edited application. <a href=\"/application/" + applicationId + "\">Continue editing application</a>",
      iconFallbackText: "Warning"
    }) }}
  {% endif %}

  {# Guidance about making a decision #}
  {% if not canAmend and phase != "dbd" and phase != "completed" %}
    <p class="govuk-body">Training providers must respond by {{ 56 | nowPlusDays("d MMMM yyyy") }}.</p>
  {% endif %}
  {% if canMakeDecision and phase == "decision" %}
    <p class="govuk-body">If you accept an offer now, your remaining applications will be withdrawn.</p>
  {% elif canMakeDecision and phase == "dbd" %}
    <p class="govuk-body">You have 12 days (until {{ 12 | nowPlusDays("d MMMM yyyy") }}) to respond to any offers. If you don’t respond, your applications will be automatically withdrawn.</p>
  {% endif %}

  {# Guidance about steps after accepting an offer #}
  {% if phase == "completed" %}
    <p class="govuk-body">We've sent you an email to confirm this. Your training provider will be in touch with you direct to explain what happens next.</p>
  {% endif %}

  {% set choices = application.choices | toArray %}
  {% include "_includes/review/choices.njk" %}
  {% if choices | length < 3 and canAmend %}
    {{ govukButton({
      classes: "govuk-button--secondary",
      text: "Add another course",
      href: applicationPath + "/choices/add"
    }) }}
  {% endif %}

  {# Guidance about withdrawing #}
  {% if (phase != "amend") %}
    <p class="govuk-body">You can withdraw an application from a training provider at any point, even after you’ve accepted an offer. You won’t be penalised, but you can’t substitute a different course or provider.</p>
  {% endif %}

  {# References #}
  <h2 class="govuk-heading-m govuk-!-font-size-27 govuk-!-margin-top-8">References</h2>

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <p class="govuk-body">We’ve contacted the referees you provided below. We’ll let you know if they don’t give a reference.</p>
    </div>
  </div>

  {% set references = application.referees %}
  {% set canAmendReferences = false %}
  {% include "_includes/review/references.njk" %}

  {% if data.flags.self_amend_contact_details %}
    {# Contact details #}
    <h2 class="govuk-heading-m govuk-!-font-size-27 govuk-!-margin-top-8">Contact details</h2>
    <p class="govuk-body">You can update your contact details at any point during the application process.</p>
    {% set contactDetails = application["contact-details"] %}
    {% set canAmend = true %}
    {% include "_includes/review/contact-details.njk" %}
  {% endif %}
{% endblock %}

{% block secondary %}
  {% include "_includes/need-help.njk" %}
  {% if not data.flags.self_amend_contact_details %}
    {{ appRelated({
      title: "Updating your contact details",
      content: {
        html: "You can update your contact details at any point during the application process. To do this, email us at <a href=\"mailto:becomingateacher@digital.education.gov.uk\">becomingateacher<wbr>@digital.education.gov.uk</a>."
      }
    }) }}
  {% endif %}
{% endblock %}
