{% extends "_content.njk" %}
{% set applicationPath = "/application/" + applicationId %}
{% set status = applicationValue(["status"]) %}
{% set incompleteTagClass = "govuk-tag--grey" %}
{% set incompleteTagText = "Incomplete" %}
{% set inprogressTagClass = "govuk-tag--purple" %}
{% set inprogressTagText = "In progress" %}
{% set notStartedTagClass = "govuk-tag--grey" %}
{% set notStartedTagText = "Not started" %}
{% set referrer = applicationPath %}
{% set international = applicationValue(["candidate", "other-nationality"]) or applicationValue(["candidate", "multiple-nationalities"]) %}

{% if applicationValue('apply2') %}
  {% set title = "Your new application" %}
{% else %}
  {% set title = "Your application" %}
{% endif %}
{% set tagText = "Completed" %}
{% set reviewText = "Check your answers before submitting" %}
{% set hasSecondary = true %}

{% block beforePageTitle %}
  {% if showCopiedBanner %}
    {{ appBanner({
      html: "<h2 class=\"govuk-heading-m\">We’ve copied your application. Please review all sections.</h2>",
      type: "success",
      icon: false
    }) }}
  {% endif %}

  {% if closed %}
    {{ appBanner({
      html: "<h2 class=\"govuk-heading-m\">Applications for courses starting this year have now closed</h2><p class=\"govuk-body-l\">Submit your application from 13 October for courses starting in 2021.</p>",
      icon: false
    }) }}
  {% endif %}
{% endblock %}

{% block pageNavigation %}
  {% if hasSubmittedApplications() %}
    {{ govukBreadcrumbs({
      items: [{
        text: "Application dashboard",
        href: "/applications"
      }, {
        text: title | safe
      }]
    }) }}
  {% endif %}
{% endblock %}

{% block beforePrimary %}
  <h1 class="govuk-heading-xl govuk-!-margin-bottom-2">{{ title | safe }}</h1>
  <p class="govuk-hint govuk-!-margin-bottom-8">Last saved on {{ "now" | date("d MMMM yyyy") }} at {{ "now" | date("t") }}</p>
{% endblock %}

{% block primary %}
  {# PREVIOUS APPLICATIONS #}
  {% if applicationValue(["apply2"]) %}
    {% set previousApplicationSummaryHtml %}
      {% include "_includes/previous-application-summary.njk" %}
    {% endset %}
    {{ govukDetails({
      summaryText: "See feedback from your previous application",
      html: previousApplicationSummaryHtml
    }) }}
  {% endif %}

  {# COURSE CHOICES #}
  {% if applicationValue(["apply2"]) %}
    <h2 class="govuk-heading-m govuk-!-font-size-27 govuk-!-margin-bottom-2">Course choice</h2>
  {% else %}
    <h2 class="govuk-heading-m govuk-!-font-size-27 govuk-!-margin-bottom-2">Course choices</h2>
    {% if closed == "true" %}
      <p class="govuk-body">You can apply for courses from 13 October.</p>
    {% else %}
      <p class="govuk-body">You can apply for up to 3 courses.</p>
    {% endif %}
  {% endif %}

  {% if applicationValue(["apply2"]) | length  %}
    {% if applicationValue(["choices"]) | length > 1 %}
      {% set choiceTagText = tagText %}
      {% set choiceTagClass = tagClass %}
    {% else %}
      {% set choiceTagText = notStartedTagText%}
      {% set choiceTagClass = notStartedTagClass %}
    {% endif %}
  {% else %}
    {% if applicationValue(["choices"]) | length > 1 %}
      {% set choiceTagText = tagText %}
    {% else %}
      {% set choiceTagText = incompleteTagText %}
      {% set choiceTagClass = incompleteTagClass %}
    {% endif %}
  {% endif %}

  {{ appTaskList({
    classes: "govuk-!-margin-bottom-8",
    items: [{
      text: "Choose your course" if applicationValue(["apply2"]) else "Choose your courses",
      href: applicationPath + "/choices",
      id: "personal-details",
      tag: {
        classes: choiceTagClass,
        text: choiceTagText
      }
    }]
  }) if not closed }}

  {# REFERENCES #}
  <h2 class="govuk-heading-m govuk-!-font-size-27 govuk-!-margin-bottom-2">References</h2>
  {% set references = applicationValue(["references"]) | toArray %}
  {% set readyReferences = references | selectattr("ready") | reverse %}
  {% set referencesContent %}
    <ul class="govuk-list">
    {% for reference in references %}
      <li class="govuk-body-s"><span class="app-status-indicator {{ reference.status | statusClass("app-status-indicator") }}"></span> <b>{{ reference.name }}</b>: {{ reference.status }}</li>
    {% endfor %}
    </ul>
  {% endset %}

  {% if readyReferences | length >= 2 %}
    {% set referencesItemText = "Review your references" %}
    {% set referencesTagText = tagText %}
    {% set referencesTagClass = tagClass %}
    {% set showReferencesContent = true %}
  {% else %}
    <p class="govuk-body govuk-!-margin-bottom-2">You need 2 references before you can submit your application.</p>
    <p class="govuk-body">It takes 8 days to get a reference on average.</p>

    {% if references | length %}
      {% set referencesItemText = "Manage your references" %}
      {% set referencesTagText = inprogressTagText %}
      {% set referencesTagClass = inprogressTagClass %}
      {% set showReferencesContent = true %}
    {% else %}
      {% set referencesItemText = "Add your references" %}
      {% set referencesTagText = incompleteTagText %}
      {% set referencesTagClass = incompleteTagClass %}
    {% endif %}
  {% endif %}

  {{ appTaskList({
    items: [{
      text: referencesItemText,
      href: applicationPath + "/references",
      id: "references",
      tag: {
        classes: referencesTagClass,
        text: referencesTagText
      },
      content: referencesContent | safe if showReferencesContent
    }]
  }) }}

  <h2 class="govuk-heading-m govuk-!-font-size-27 govuk-!-margin-top-4">About you</h2>
  {{ appTaskList({
    classes: "govuk-!-margin-bottom-8",
    items: [{
      text: "Personal details",
      href: applicationPath + "/personal-details" + ("/review" if applicationValue(["candidate"]) | length > 0),
      id: "personal-details",
      tag: {
        classes: tagClass if applicationValue(["completed", "personal-details"]) else incompleteTagClass,
        text: tagText if applicationValue(["completed", "personal-details"]) else incompleteTagText
      }
    }, {
      text: "Contact details",
      href: applicationPath + "/contact-details" + ("/review" if applicationValue(["contact-details", "address"])),
      id: "contact-details",
      tag: {
        classes: tagClass if applicationValue(["completed", "contact-details"]) else incompleteTagClass,
        text: tagText if applicationValue(["completed", "contact-details"]) else incompleteTagText
      }
    }, {
      text: "Work history",
      href: applicationPath + "/work-history" + ("/review" if applicationValue("work-history") | length > 0),
      id: "work-history",
      tag: {
        classes: tagClass if applicationValue(["completed", "work-history"]) else incompleteTagClass,
        text: tagText if applicationValue(["completed", "work-history"]) else incompleteTagText
      }
    }, {
      text: "Unpaid experience and volunteering",
      href: applicationPath + "/school-experience" + ("/review" if applicationValue("school-experience") | length > 0),
      id: "school-experience",
      tag: {
        classes: tagClass if applicationValue(["completed", "school-experience"]) else incompleteTagClass,
        text: tagText if applicationValue(["completed", "school-experience"]) else incompleteTagText
      }
    }, {
     text: "Asking for support if you have a disability",
     href: applicationPath + "/reasonable-adjustments" + ("/review" if applicationValue("reasonable-adjustments") | length > 0),
     id: "reasonable-adjustments",
     tag: {
        classes: tagClass if applicationValue(["completed", "reasonable-adjustments"]) else incompleteTagClass,
        text: tagText if applicationValue(["completed", "reasonable-adjustments"]) else incompleteTagText
     }
   }, {
    text: "Declaring any safeguarding issues",
    href: applicationPath + "/suitability" + ("/review" if applicationValue("suitability") | length > 0),
    id: "suitability",
    tag: {
      classes: tagClass if applicationValue(["completed", "suitability"]) else incompleteTagClass,
      text: tagText if applicationValue(["completed", "suitability"]) else incompleteTagText
    }
  }]
  }) }}

  <h2 class="govuk-heading-m govuk-!-font-size-27 govuk-!-margin-bottom-2">Qualifications</h2>
  {{ appTaskList({
    classes: "govuk-!-margin-bottom-8",
    items: [{
      text: "Degree",
      href: applicationPath + "/degree" + ("/review" if applicationValue(["degree"]) | length > 0 else "/add"),
      id: "degree",
      tag: {
        classes: tagClass if applicationValue(["completed", "degree"]) else incompleteTagClass,
        text: tagText if applicationValue(["completed", "degree"]) else incompleteTagText
      }
    }, {
      text: "Maths GCSE or equivalent",
      href: applicationPath + "/gcse/maths" + ("/review" if applicationValue(["gcse", "maths"]) | length > 0),
      id: "maths-gcse",
      tag: {
        classes: tagClass if applicationValue(["completed", "maths"]) else incompleteTagClass,
        text: tagText if applicationValue(["completed", "maths"]) else incompleteTagText
      }
    }, {
      text: "English GCSE or equivalent",
      href: applicationPath + "/gcse/english" + ("/review" if applicationValue(["gcse", "english"]) | length > 0),
      id: "english-gcse",
      tag: {
        classes: tagClass if applicationValue(["completed", "english"]) else incompleteTagClass,
        text: tagText if applicationValue(["completed", "english"]) else incompleteTagText
      }
    }, {
      text: "Science GCSE or equivalent",
      href: applicationPath + "/gcse/science" + ("/review" if applicationValue(["gcse", "science"]) | length > 0),
      id: "science-gcse",
      tag: {
        classes: tagClass if applicationValue(["completed", "science"]) else incompleteTagClass,
        text: tagText if applicationValue(["completed", "science"]) else incompleteTagText
      }
    } if hasPrimaryChoices() or applicationValue(["gcse", "science"]), {
      text: "Academic and other relevant qualifications",
      href: applicationPath + "/other-qualifications" + ("/review" if applicationValue(["other-qualifications"]) | length > 0 else "/add"),
      id: "other-qualifications",
      tag: {
        classes: tagClass if applicationValue(["completed", "other-qualifications"]) | length > 0 else incompleteTagClass,
        text: tagText if applicationValue(["completed", "other-qualifications"]) | length > 0 else incompleteTagText
      }
    }, {
      text: "English as a foreign language",
      href: applicationPath + "/english-language" + ("/review" if applicationValue(["english-language"]) | length > 0),
      id: "english-language",
      tag: {
        classes: tagClass if applicationValue(["completed", "english-language"]) | length > 0 else incompleteTagClass,
        text: tagText if applicationValue(["completed", "english-language"]) | length > 0 else incompleteTagText
      }
    } if international]
  }) }}

  <h2 class="govuk-heading-m govuk-!-font-size-27 govuk-!-margin-bottom-2">Personal statement</h2>
  {{ appTaskList({
    classes: "govuk-!-margin-bottom-8",
    items: [{
      text: "Why do you want to be a teacher?",
      href: applicationPath + "/personal-statement" + ("/review" if applicationValue(["personal-statement"]) | length > 0),
      id: "personal-statement",
      tag: {
        classes: tagClass if applicationValue(["completed", "personal-statement"]) | length > 0 else incompleteTagClass,
        text: tagText if applicationValue(["completed", "personal-statement"]) | length > 0 else incompleteTagText
      }
    }, {
      text: "Your knowledge about the subject you want to teach",
      href: applicationPath + "/subject-knowledge" + ("/review" if applicationValue(["subject-knowledge"]) | length > 0),
      id: "subject-knowledge",
      tag: {
        classes: tagClass if applicationValue(["completed", "subject-knowledge"]) | length > 0 else incompleteTagClass,
        text: tagText if applicationValue(["completed", "subject-knowledge"]) | length > 0 else incompleteTagText
      }
    }, {
      text: "Interview needs",
      href: applicationPath + "/interview" + ("/review" if applicationValue(["interview"]) | length > 0),
      id: "interview",
      tag: {
        classes: tagClass if applicationValue(["completed", "interview"]) | length > 0 else incompleteTagClass,
        text: tagText if applicationValue(["completed", "interview"]) | length > 0 else incompleteTagText
      }
    }]
  }) }}

  {% if closed %}
    <h2 class="govuk-heading-m govuk-!-font-size-27">Review</h2>
    <p class="govuk-body">Applications for courses starting in 2021 open from 13 October. You can continue to make changes to your application until then.</p>
    {{ govukButton({
      classes: "govuk-button--secondary",
      text: "Review your application",
      href: applicationPath + "/review?closed=true"
    }) }}
  {% else %}
    <h2 class="govuk-heading-m govuk-!-font-size-27">Check and submit</h2>
    {{ govukButton({
      text: "Check and submit your application",
      href: applicationPath + "/review"
    }) }}
  {% endif %}

{% endblock %}

{% block secondary %}
  {% include "_includes/need-help.njk" %}
{% endblock %}
